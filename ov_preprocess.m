dir_raw = 'aqxkl_raw';

% DO NOT EDIT BELOW THIS LINE
dir_stabilized = 'stabilized-images';
dir_diff = 'differenced-images';
dir_diff_binary = sprintf('%s-binary',dir_diff);
dir_temp = 'temp';

% list out all files
filenames_raw = dir(fullfile(dir_raw, '*.tif'));
% count number of files
num_files = size(filenames_raw,1);

% make a temporary directory
mkdir(dir_temp)

% make temp dir, rewrite files in numeric order
for i=1:num_files
    % load in each image
    im_this = imread(fullfile(dir_raw, filenames_raw(i).name));
    % make RGB for stabilizer
    imwrite(cat(3, im_this, im_this, im_this),fullfile(dir_temp,sprintf('%d.tiff',i)),'Compression','LZW');
    i
end

% run stabilizer
% https://github.com/Jeff-Ding/Video-Stabilizer#example
stabilize('temp',dir_stabilized,'tiff', num_files, 1)

% remove temp dir and all files within it (brave!!)
rmdir dir_temp s;

% rename the stabilized files back
for i=1:num_files
    fstart = fullfile(dir_stabilized, sprintf('%d.tiff',i));
    fend = fullfile(dir_stabilized, filenames_raw(i).name);
    movefile(fstart,fend);  
    i
end

% make differenced folder outputs
mkdir(dir_diff);
mkdir(dir_diff_binary);

% do differences
for i=1:num_files
    if (i>1)
        im_prev = im_this;
    end
    
    im_this = imread(fullfile(dir_stabilized, filenames_raw(i).name));
    im_this = im_this(:,:,1);
    
    % figure out which sections represent misalignments
    im_mask = (im_this==0) | (im_prev==0);
    
    
    if (i>1)
        % mask out the differences from stabilizations
        im_diff = im_this - im_prev;
        im_diff = im_diff .* uint8(~im_mask);
        
        imwrite(im_diff, fullfile(dir_diff, filenames_raw(i).name));
        
        % calculate a thresholded version with otsu threshold (naive
        % approach) - eventually replace this with a deep learning
        % algorithm
        im_diff_binary = imbinarize(im_diff,graythresh(im_diff));
        [~, filename_binary_base, ~] = fileparts(filenames_raw(i).name);
        
        imwrite(im_diff_binary, fullfile(dir_diff_binary, sprintf('%s-threshold.tif', filename_binary_base)));
    end
    
    i
end